<!DOCTYPE html>
<head>
    <meta charset="utf-8">
    <style>
        * {
            margin: 0;
            padding: 0;
        }
        svg {
            margin: 0 auto;
        }
    </style>
</head>

<body>
    <section class="container"></section>
    
    <script src="d3.v3.min.js" charset="utf-8"></script>
    <script type='text/javascript'>

        window.addEventListener('load', function () {
                             
            d3.xml('ui.svg', 'image/svg+xml', function (error, data) {
                
                // add SVG to document
                d3.select('body').node().appendChild(data.documentElement);
                
                // get interactive elements
                var svg = d3.select('svg');
                
                var view = d3.select('#view');
                var w = +view.attr('width');
                var h = +view.attr('height');
                
                var btn = svg.select("#button");
                var btnbg = svg.select("#button-bg");
                var sb = svg.select("#scrollbar");
                var pArea = svg.select("#progress-area");
                var pMarker = svg.select("#progress-marker");
                                
                //var tr = d3.transform(d3.select(this).attr("transform"));
                //var btnx = tr.translate[0];
                
                btn.on('mouseover', function () {
                });                
                
                btn.on('mousedown', function () {
                    btnbg.style('fill', '#ffcb6e');
                });
                
                btn.on('mouseup', function () {
                    btnbg.style('fill', '#ffb329');
                    //var x = view.;
                    var newTransform = d3.select(this).attr("transform").replace(/\([^,]+,/, "(" + -2440 + ",");
                    btn
                        .transition()
                        .duration(500)
                        .ease('bounce')
                        .attr('transform', newTransform);
                    
                    pArea
                        .transition()
                        .duration(100)
                        .ease('ease-out')
                        .attr('width', +pArea.attr('width'));
                });
            
            var drag = d3.behavior.drag()
                .on("drag", dragmove);
            
            var testDrag = btn.call(drag);

            function dragmove(d) {
                // var newX = -2320; 
                // -2580  ... -2300     280
                //   280  ...   590
                /*
                var t = d3.transform(d3.select(this).attr("transform"));            
                var currx = t.translate[0];
                var curry = t.translate[1];
                */
                var newX = d3.event.x - 2870;                
                newX = Math.max(-2580, Math.min(-2300, newX));
                
                var newTransform = d3.select(this).attr("transform").replace(/\([^,]+,/, "(" + newX + ",");
                d3.select(this).attr("transform", newTransform);
                
                scrollTime(newX + 2440);
                
                console.log("D3:  " + d3.event.x);
                console.log("NEWX:  " + newX);
            }
            
            
            
            function scrollTime(pos) {
                var target = 0;
                if (pos > 0) target = 396;
                
                f = (Math.abs(pos) / 140) * 0.7 + 0.1;
                console.log("POS:  " + Math.abs(pos) + "    F:  " + f);
                //var width = +pArea.attr('width');
                
                console.log("TR  " + target)
                console.log("SPEED  " + f);
                
                // 1 ...    200ms
                // 0 ... 20.000ms
                pArea
                    .transition()
                    //.duration(200 * (Math.log(1/(1 + 0.00001)) + 1))
                    //.duration(15000 * 1/(20 * f + 0.1))
                    .duration(60000 * Math.pow(f-1,6) + 200)
                    .ease('linear')
                    .attr('width', target);
            }

                /*
                var appScreen = svg.select('#ScreenBackground');
                var screenWidth = +appScreen.attr('width'),
                  screenHeight = +appScreen.attr('height');
                var appButton = svg.select('#AppButton')
                  .on('mouseenter', function () {
                      appButton.style('fill', '#AB69C6');
                  })
                  .on('mouseleave', function () {
                      appButton.style('fill', '#9B59B6')
                  })
                  .on('click', function () {
                      var x = Math.random() * screenWidth;
                      var y = Math.random() * screenHeight;
                      appButton
                          .transition()
                          .duration(1000)
                          .ease('bounce')
                          .attr('cx', x)
                          .attr('cy', y);
                });
                */
            });
            
            
            /*
            d3.xml('proto.svg', 'image/svg+xml', function (error, data) {
                if (error) {
                    console.log('Error while loading the SVG file!', error);
                }
                else {
                    // add SVG to document
                    d3.select('.container')
                        .node()
                        .appendChild(data.documentElement);
                        
                    // interactive elements
                    var 
                }
            });
            */

        });

    </script>
</body>
